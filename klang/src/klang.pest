// Pest Grammar for the Custom Language

// Comments
COMMENT = _{ "//" ~ (!"\n" ~ ANY)* }

// Whitespaces
WHITESPACE = _{ " " | "\t" | "\n" | "\r" }

// Identifiers (function names, variable names, etc.)
IDENT = @{ ASCII_ALPHANUMERIC+ ~ ("_" ~ ASCII_ALPHANUMERIC+)* }

// File input (the program)
file_input = { SOI ~ stmt* ~ EOI }

// Statements include function definitions, function calls, and other constructs.
stmt = _{ ( import_stmt | function_def | expr_stmt ) }

// Import statement
import_stmt = { "from" ~ module ~ "import" ~ import_list }
module = @{ IDENT ~ ( "." ~ IDENT )* }
import_list = { import_item ~ ("," ~ import_item )* }
import_item = @{ IDENT }

// Function definition
function_def = _{ "fn" ~ IDENT ~ "(" ~ param_list? ~ ")" ~ block }

param_list = _{ (IDENT ~ "=" ~ expr) ~ ("," ~ IDENT ~ "=" ~ expr)* }

// Block of statements enclosed in curly braces
block = _{ "{" ~ stmt* ~ "}" }

// Expression statement
expr_stmt = _{ expr ~ ";"? }

// Expression (can be a function call, assignment, or binary operation)
expr = _{ (
    function_call
    | assignment
    | binary_op
    | unary_op
    | literal
    | loop_expr
    | COMMENT
    | IDENT
) }


// Function call with potential async operator `*`
function_call = _{ ( async_call | standard_call ) }
async_call = _{ "*" ~ standard_call }
standard_call = _{ IDENT ~ "(" ~ arg_list? ~ ")" }
arg_list = _{ expr ~ ("," ~ expr)* }

// Containers
container = _{ list | dict }
list = _{ "[" ~ expr ~ "," ~ expr ~ "]" }
dict = _{ "{" ~ pair ~ ("," ~ pair)* ~ "}" }
pair = _{ key ~ ":" ~ value }
key = _{ IDENT | literal }
value = _{ expr }

// Assignment statement
assignment = _{ IDENT ~ "=" ~ expr }

// Binary operation
binary_op = _{ primary_expr ~ (binary_operator ~ primary_expr)* }
binary_operator = _{ "+" | "-" | "*" | "/" | "?" | ":" }
primary_expr = _{ IDENT | literal | function_call | "(" ~ expr ~ ")" }

// Unary operation (negation, etc.)
unary_op = _{ unary_operator ~ expr }
unary_operator = _{ "-" | "!" }

// Literals include numbers and units like `30deg`, `0.1rad`
literal = _{ (
    number_with_unit
    | number
    | string
    | boolean
) }

number_with_unit = _{ number ~ unit }
unit = _{ "deg" | "rad" | "m" | "cm" | "mm" | "ft" | "in" }

number = @{ ASCII_DIGIT+ ~ ("." ~ ASCII_DIGIT+)? }
string = @{ "\"" ~ (!"\"" ~ ANY)* ~ "\"" }
boolean = _{ "true" | "false" }

// Range for which to loop through in for loop
range = _{ "[" ~ (NUMBER ~ ("," ~ NUMBER)*) ~ "]" }

// A loop with `for` and `while` constructs
loop_expr = _{ ( for_loop | while_loop ) }

for_loop = _{ "for" ~ IDENT ~ ":" ~ range ~ block }
while_loop = _{ "while" ~ expr ~ block }
